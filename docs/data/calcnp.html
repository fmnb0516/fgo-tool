<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="../resources/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../resources/jquery-ui-1.12.1/jquery-ui.min.css">
    <title>FGO データ編集</title>
</head>

<body>

    <div class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary">
        <div class="container">
            <a href="./index.html" class="navbar-brand">FGO サーヴァント一覧</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="./list.html">サーヴァント一覧</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./calcnp.html">FGO 獲得NP計算機</a>
                    </li>
                </ul>

            </div>
        </div>
    </div>

    <div class="container" style="padding-top: 70px;" id="container">
        <div id="atackerContainer" class="row"
            style="border: 1px solid #f0f0f0;border-radius: 0.25rem;position: relative;">
            <div style="position: absolute;top: -10px;left: 10px;">
                <span class="badge badge-primary" style="cursor: pointer">アタッカー</span>
            </div>

            <div class="col-lg-12" style="padding-top: 10px;">
                <div class="form-group">
                    <label for="name-input">名称</label>
                    <input autocomplete="off" type="text" class="form-control" id="target-servant-input" value="">
                </div>
            </div>

            <div class="col-lg-12">
                <div class="row" style="padding: 15px;">
                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="level-input">Lv</label>
                            <select class="form-control" id="level-input">
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <div class="form-group">
                            <label for="atk-input">ATK</label>
                            <input id="atk-input" type="text" class="form-control" value="">
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="form-group">
                            <label for="for-atk-input">フォウくん(atk)</label>
                            <input id="for-atk-input" type="text" class="form-control" value="1000">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="hogu-lv-input">宝具Lv</label>
                            <select class="form-control" id="hogu-lv-input">
                                <option value="1">lv1</option>
                                <option value="2">lv2</option>
                                <option value="3">lv4</option>
                                <option value="4">lv4</option>
                                <option value="5">lv5</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="hogu-oc-input">宝具OC</label>
                            <select class="form-control" id="hogu-oc-input">
                                <option value="1">oc1</option>
                                <option value="2">oc2</option>
                                <option value="3">oc4</option>
                                <option value="4">oc4</option>
                                <option value="5">oc5</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="form-group">
                            <label for="target-skill1-lv-input">スキル1Lv</label>
                            <select class="form-control" id="target-skill1-lv-input">
                                <option value="">使用しない</option>
                                <option value="1">lv1</option>
                                <option value="2">lv2</option>
                                <option value="3">lv3</option>
                                <option value="4">lv4</option>
                                <option value="5">lv5</option>
                                <option value="6">lv6</option>
                                <option value="7">lv7</option>
                                <option value="8">lv8</option>
                                <option value="9">lv9</option>
                                <option value="10">lv10</option>
                            </select>
                            <small class="form-text text-muted" id="target-skill1-lv-name"></small>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="form-group">
                            <label for="target-skill2-lv-input">スキル2Lv</label>
                            <select class="form-control" id="target-skill2-lv-input">
                                <option value="">使用しない</option>
                                <option value="1">lv1</option>
                                <option value="2">lv2</option>
                                <option value="3">lv3</option>
                                <option value="4">lv4</option>
                                <option value="5">lv5</option>
                                <option value="6">lv6</option>
                                <option value="7">lv7</option>
                                <option value="8">lv8</option>
                                <option value="9">lv9</option>
                                <option value="10">lv10</option>
                            </select>
                            <small class="form-text text-muted" id="target-skill2-lv-name"></small>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="form-group">
                            <label for="target-skill3-lv-input">スキル3Lv</label>
                            <select class="form-control" id="target-skill3-lv-input">
                                <option value="">使用しない</option>
                                <option value="1">lv1</option>
                                <option value="2">lv2</option>
                                <option value="3">lv3</option>
                                <option value="4">lv4</option>
                                <option value="5">lv5</option>
                                <option value="6">lv6</option>
                                <option value="7">lv7</option>
                                <option value="8">lv8</option>
                                <option value="9">lv9</option>
                                <option value="10">lv10</option>
                            </select>
                            <small class="form-text text-muted" id="target-skill3-lv-name"></small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-12" style="margin-bottom: 10px;">
                <button type="button" class="btn btn-primary btn-sm toggle-btn" data-target="#target-detail">詳細</button>
            </div>

            <div class="col-lg-12" id="target-detail" style="display: none">
                <div class="row" style="padding: 15px;">
                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="na-input">N/A</label>
                            <input id="na-input" type="text" class="form-control" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="hit-input">ヒット数</label>
                            <input type="text" class="form-control" id="hit-input" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="card-input">Card</label>
                            <select class="form-control" id="card-input">
                                <option value=""></option>
                                <option value="a">Arts</option>
                                <option value="b">Buster</option>
                                <option value="q">Quick</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="hogu-type-input">宝具種別</label>
                            <select class="form-control" id="hogu-type-input">
                                <option value=""></option>
                                <option value="support">補助宝具</option>
                                <option value="all">全体宝具</option>
                                <option value="single">単体宝具</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-np-buf-input">NP獲得量バフ</label>
                            <input id="target-np-buf-input" type="text" class="form-control" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-np-get-input">ターン後NP獲得</label>
                            <input id="target-np-get-input" type="text" class="form-control" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-tenchizin-input">天地人</label>
                            <select class="form-control" id="target-tenchizin-input">
                                <option value="ten">天</option>
                                <option value="chi">地</option>
                                <option value="hito">人</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="tokkou-enable-input">特攻宝具</label>
                            <select class="form-control" id="tokkou-enable-input">
                                <option value="y">あり</option>
                                <option value="n">なし</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-compatibility-input">有利不利</label>
                            <select class="form-control" id="target-compatibility-input">
                                <option value="1.0">等倍</option>
                                <option value="2.0">2倍</option>
                                <option value="1.5">1.5倍</option>
                                <option value="0.5">不利</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-card-buf-input">攻バフ・防デバフ</label>
                            <input id="target-atk-buf-input" type="text" class="form-control" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-card-buf-input">Cardバフ</label>
                            <input id="target-card-buf-input" type="text" class="form-control" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-hogu-buf-input">宝具バフ</label>
                            <input id="target-hogu-buf-input" type="text" class="form-control" value="">
                            <small class="form-text text-muted">その他、特攻バフなど</small>
                        </div>
                    </div>



                    <div class="col-lg-2">
                    </div>
                </div>
            </div>
        </div>

        <!--
        <div class="row">
            
        </div>

        <div class="row">
            <div class="col-lg-12">
                <h5>サポート</h5>
            </div>
            <div class="col-lg-6">
                <div class="col-lg-12">
                    <div class="form-group">
                        <label for="name-input">名称</label>
                        <input autocomplete="off" type="text" class="form-control" id="support-servant-input" value="">
                    </div>

                    <div class="alert alert-dismissible alert-primary" id="support-box">
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label for="ext-card-buf-input">Cardバフ(追加)</label>
                            <input id="ext-card-buf-input" type="text" class="form-control" value="0">
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <div class="form-group">
                            <label for="ext-np-buf-input">NP獲得量バフ(追加)</label>
                            <input id="ext-np-buf-input" type="text" class="form-control" value="0">
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <div class="form-group">
                            <label for="ext-np-get-input">ターン後NP獲得(追加)</label>
                            <input id="ext-np-get-input" type="text" class="form-control" value="0">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <h5>獲得NP計算</h5>
            </div>
            <div class="col-lg-12">
                <button id="calc-btn" type="button" class="btn btn-primary">計算</button>
                <br /><br />

                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th scope="col">OverKill</th>
                            <th scope="col">剣/弓/槍(1.0)</th>
                            <th scope="col">術(1.2)</th>
                            <th scope="col">騎(1.1)</th>
                            <th scope="col">殺(0.9)</th>
                            <th scope="col">狂(0.8)</th>
                        </tr>
                    </thead>
                    <tbody id="result-box">
                    </tbody>
                </table>
            </div>
            <div class="col-lg-4">
                <div class="form-group">
                    <label for="calc-card-buf-input">Cardバフ(累計)</label>
                    <input readonly id="calc-card-buf-input" type="text" class="form-control" value="0">
                </div>
            </div>

            <div class="col-lg-4">
                <div class="form-group">
                    <label for="calc-np-buf-input">NP獲得量バフ(累計)</label>
                    <input readonly id="calc-np-buf-input" type="text" class="form-control" value="0">
                </div>
            </div>

            <div class="col-lg-4">
                <div class="form-group">
                    <label for="calc-np-get-input">ターン後NP獲得(累計)</label>
                    <input readonly id="calc-np-get-input" type="text" class="form-control" value="0">
                </div>
            </div>
        </div>
        -->
    </div>

    <script type="text/x-handlebars" id="template-result">
        {{#each this}}
        <tr>
            <td>{{label}}</td>
            <td>{{d1}} ({{multi 3 d1}})</td>
            <td>{{d2}} ({{multi 3 d2}})</td>
            <td>{{d3}} ({{multi 3 d3}})</td>
            <td>{{d4}} ({{multi 3 d4}})</td>
            <td>{{d5}} ({{multi 3 d5}})</td>
        </tr>
        {{/each}}
    </script>

    <div>
        <script src="../resources/jquery/jquery-3.4.1.min.js"></script>
        <script src="../resources/jquery-ui-1.12.1/jquery-ui.min.js"></script>
        <script src="../resources/bootstrap/js/bootstrap.js"></script>
        <script src="../resources/handlebars/handlebars-v4.2.0.js"></script>
        <script src="../resources/fgoutil/fgocalc.js"></script>
        <script src="../servant.js"></script>

        <script type="text/javascript">

            $(function () {
                Handlebars.registerHelper('multi', function (v, d) {
                    var val = v * d;
                    return Math.round(val * 10) / 10;
                });

                function getServantNo(val) {
                    return val.substring(0, val.indexOf("-"));
                };

                function getServantData(no) {
                    return fgo.data().find(function (d) {
                        return d.servant.no === no;
                    });
                };

                function bufTo(v) {
                    return v === 0 ? v : v / 100;
                };

                function calcNp(card, na, hoguHit, overkill, hosei, buf) {
                    var val = fgo.calcNp(na, card, bufTo(buf.cardbuf), bufTo(buf.npbuf), hoguHit, overkill, hosei);
                    return Math.round(val * 10) / 10;
                };

                function classSkillBuff(card, effect, buf) {
                    var cardbuflabel = {
                        "a": "Artsカード性能アップ",
                        "q": "Quickカード性能アップ",
                        "b": "Busterカード性能アップ"
                    };

                    if (effect.type === "NP獲得量アップ") {
                        buf.npbuf += parseFloat(effect.magnification);
                    }

                    if (effect.type === "NP獲得状態付与") {
                        buf.npget += parseFloat(effect.magnification);
                    }

                    if (effect.type === cardbuflabel[card]) {
                        buf.cardbuf += parseFloat(effect.magnification);
                    }
                };

                function orgSkillBuff(card, lv, effect, buf) {
                    var cardbuflabel = {
                        "a": "Artsカード性能アップ",
                        "q": "Quickカード性能アップ",
                        "b": "Busterカード性能アップ"
                    };

                    if (effect.target !== "self" && effect.target !== "self-other") {
                        return;
                    }

                    if (effect.type === "NP獲得量アップ") {
                        buf.npbuf += parseFloat(effect["v" + lv]);
                    }

                    if (effect.type === "NP獲得状態付与") {
                        buf.npget += parseFloat(effect["v" + lv]);
                    }

                    if (effect.type === cardbuflabel[card]) {
                        buf.cardbuf += parseFloat(effect["v" + lv]);
                    }
                };

                function supportSkillBuff(card, effect, buf) {
                    var cardbuflabel = {
                        "a": "Artsカード性能アップ",
                        "q": "Quickカード性能アップ",
                        "b": "Busterカード性能アップ"
                    };

                    if (effect.target !== "other-single"
                        && effect.target !== "other-all"
                        && effect.target !== "self-other") {

                        return;
                    }

                    if (effect.type === "NP獲得量アップ") {
                        buf.npbuf += parseFloat(effect.v10);
                    }

                    if (effect.type === "NP獲得状態付与") {
                        buf.npget += parseFloat(effect.v10);
                    }

                    if (effect.type === cardbuflabel[card]) {
                        buf.cardbuf += parseFloat(effect.v10);
                    }
                };

                function updateAttackerBuf(no) {
                    var data = getServantData(no);
                    var hoguLevel = parseInt($("#hogu-lv-input").val());
                    var hoguOC = parseInt($("#hogu-oc-input").val());
                    var skill1 = $("#target-skill1-lv-input").val();
                    var skill2 = $("#target-skill2-lv-input").val();
                    var skill3 = $("#target-skill3-lv-input").val();

                    var buf = { npbuf: 0, cardbuf: 0, npget: 0, atkbuf: 0, hogubuf: 0 };

                    data.classskill.forEach(function (s) {
                        s.effect.forEach(function (e) {
                            classSkillBuff(data.hogu.card, e, buf);
                        });
                    });

                    if (skill1 !== "") {
                        data.skill1.effects.forEach(function (e) {
                            orgSkillBuff(data.hogu.card, skill1, e, buf);
                        });
                    }

                    if (skill2 !== "") {
                        data.skill2.effects.forEach(function (e) {
                            orgSkillBuff(data.hogu.card, skill2, e, buf);
                        });
                    }

                    if (skill3 !== "") {
                        data.skill3.effects.forEach(function (e) {
                            orgSkillBuff(data.hogu.card, skill3, e, buf);
                        });
                    }

                    $("#target-card-buf-input").val(buf.cardbuf);
                    $("#target-np-buf-input").val(buf.npbuf);
                    $("#target-np-get-input").val(buf.npget);
                    $("#target-atk-buf-input").val(buf.atkbuf);
                    $("#target-hogu-buf-input").val(buf.hogubuf);
                };

                var servantAutoCompleteData = fgo.data().map(function (d) {
                    return d.servant.no + "-星" + d.servant.rare + "-" + fgo.classToLabel(d.servant.clazz) + "-" + d.servant.name;
                });

                $("#target-servant-input").autocomplete({
                    source: servantAutoCompleteData,
                    select: function (e, d) {
                        var no = getServantNo(d.item.value);
                        var data = getServantData(no);

                        $("#level-input").html(data.status.map(function (status) {
                            return "<option value=\"" + (status.atk) + "\">" + (status.level) + "</option>";
                        }).join());
                        $("#atk-input").val(data.status[0].atk);

                        $("#hogu-oc-input").val("1");
                        $("#hogu-lv-input").val(data.servant.rare >= 4 ? "1" : "5");

                        $("#na-input").val(data.hidden.na);
                        $("#hit-input").val(data.hogu.hit);
                        $("#card-input").val(data.hogu.card);
                        $("#hogu-type-input").val(data.hogu.type);

                        $("#target-skill1-lv-input").val("10");
                        $("#target-skill1-lv-name").text(data.skill1.name);
                        $("#target-skill2-lv-input").val("10");
                        $("#target-skill2-lv-name").text(data.skill2.name);
                        $("#target-skill3-lv-input").val("10");
                        $("#target-skill3-lv-name").text(data.skill3.name);

                        $("#tokkou-enable-input").val("n");
                        $("#target-compatibility-input").val("1.0");
                        $("#target-tenchizin-input").val(data.servant.tenchizin);

                        $("#atackerContainer").attr("no", no);

                        updateAttackerBuf(no);
                        $("#target-servant-input").blur();
                    }
                });

                $("#support-servant-input").autocomplete({
                    source: servantAutoCompleteData,
                    select: function (e, d) {
                        $("#support-box").append($("<span>").attr("class", "badge badge-dark")
                            .attr("style", "cursor: pointer;padding: 10px;margin: 3px;")
                            .text(d.item.value));
                        $("#support-servant-input").blur();
                    }
                });

                $("#support-servant-input").focus(function () {
                    $("#support-servant-input").val("");
                });

                $("#target-skill1-lv-input,#target-skill2-lv-input,#target-skill3-lv-input").change(function () {
                    var no = $("#atackerContainer").attr("no");
                    if(no !== undefined && no !== null && no !== "") {
                        updateAttackerBuf(no);
                    }
                });

                $("#atk-input,#for-atk-input,#hogu-lv-input,#hogu-oc-input").change(function () {
                    var no = $("#atackerContainer").attr("no");
                    if(no !== undefined && no !== null && no !== "") {
                        updateAttackerBuf(no);
                    }
                });

                $("#level-input").change(function () {
                    $("#atk-input").val($(this).val());
                    var no = $("#atackerContainer").attr("no");
                    if(no !== undefined && no !== null && no !== "") {
                        updateAttackerBuf(no);
                    }
                });

                $(document).on("click", ".toggle-btn", function () {
                    var targetId = $(this).attr("data-target");
                    var target = $(targetId);
                    if (target.is(':visible')) {
                        target.hide();
                    } else {
                        target.show();
                    }
                });

                /*
                $(document).on("click", "#calc-btn", function () {
                    var buf = { npbuf: 0, cardbuf: 0, npget: 0 };
                    var hoguCard = $("#card-input").val();
                    var hoguHit = parseInt($("#hit-input").val());
                    var na = parseFloat($("#na-input").val());
                    var cardHosei = fgo.getCardNp(hoguCard);

                    buf.cardbuf += parseFloat($("#target-card-buf-input").val());
                    buf.npbuf += parseFloat($("#target-np-buf-input").val());
                    buf.npget += parseFloat($("#target-np-get-input").val());

                    buf.cardbuf += parseFloat($("#ext-card-buf-input").val());
                    buf.npbuf += parseFloat($("#ext-np-buf-input").val());
                    buf.npget += parseFloat($("#ext-np-get-input").val());

                    $("#support-box span").each(function () {
                        var no = getServantNo($(this).text().trim());
                        var data = getServantData(no);

                        data.skill1.effects.forEach(function (e) {
                            supportSkillBuff(hoguCard, e, buf);
                        });
                        data.skill2.effects.forEach(function (e) {
                            supportSkillBuff(hoguCard, e, buf);
                        });
                        data.skill3.effects.forEach(function (e) {
                            supportSkillBuff(hoguCard, e, buf);
                        });
                    });

                    $("#calc-card-buf-input").val(buf.cardbuf);
                    $("#calc-np-buf-input").val(buf.npbuf);
                    $("#calc-np-get-input").val(buf.npget);

                    const calcResult = [];
                    for (var i = 0; i < hoguHit; i++) {
                        calcResult.push({
                            label: "OverKill " + (i + 1),
                            d1: calcNp(cardHosei, na, hoguHit, i + 1, 1.0, buf),
                            d2: calcNp(cardHosei, na, hoguHit, i + 1, 1.2, buf),
                            d3: calcNp(cardHosei, na, hoguHit, i + 1, 1.1, buf),
                            d4: calcNp(cardHosei, na, hoguHit, i + 1, 0.9, buf),
                            d5: calcNp(cardHosei, na, hoguHit, i + 1, 0.8, buf)
                        });
                    }

                    var template = Handlebars.compile($("#template-result").html());
                    $("#result-box").html(template(calcResult));
                });
                */
            });
        </script>
    </div>
</body>

</html>