<!doctype html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="../resources/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="../resources/jquery-ui-1.12.1/jquery-ui.min.css">
    <title>FGO データ編集</title>
</head>

<body>

    <div class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary">
        <div class="container">
            <a href="./index.html" class="navbar-brand">FGO サーヴァント一覧</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="./list.html">サーヴァント一覧</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./calcnp.html">FGO 獲得NP計算機</a>
                    </li>
                </ul>

            </div>
        </div>
    </div>

    <div class="container" style="padding-top: 70px;" id="container">
        <div id="atackerContainer" class="row"
            style="border: 1px solid #f0f0f0;border-radius: 0.25rem;position: relative;">
            <div style="position: absolute;top: -10px;left: 10px;">
                <span class="badge badge-primary" style="cursor: pointer">アタッカー</span>
            </div>

            <div style="position: absolute;top: -10px;right: 10px;">
                <button id="clearnBtn" type="button" class="btn btn-primary btn-sm">クリア</button>
            </div>

            <div class="col-lg-12" style="padding-top: 10px;">
                <div class="form-group">
                    <label for="name-input">名称</label>
                    <input autocomplete="off" type="text" class="form-control" id="target-servant-input" value="">
                    <small class="form-text text-muted">
                        NP計算対象のサーヴァント名を入力してください
                        <br />
                        入力に応じて候補がサジェスト表示されます。
                    </small>
                </div>
            </div>

            <div class="col-lg-12" style="margin-bottom: 10px;">
                <button type="button" class="btn btn-primary btn-sm toggle-btn"
                    data-target="#target-basic">基本データ</button>
                <small class="form-text text-muted">
                    対象サーヴァントのATK,スキルの使用可否等の基本データを表示します。
                </small>
            </div>

            <div class="col-lg-12" id="target-basic" style="display: none">
                <div class="row" style="padding: 15px;">
                    <div class="col-lg-12">
                        <div class="row">
                            <div class="col-lg-2">
                                <div class="form-group">
                                    <label for="level-input">Lv</label>
                                    <select class="form-control" id="level-input">
                                    </select>
                                    <small class="form-text text-muted">
                                        選択したレベルに応じてATKが切り替わります
                                    </small>
                                </div>
                            </div>

                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="atk-input">ATK</label>
                                    <input readonly id="atk-input" type="number" class="form-control" value="">
                                    <small class="form-text text-muted">
                                        サーヴァントのATKを入力してください
                                    </small>
                                </div>
                            </div>
                            <div class="col-lg-3">
                                <div class="form-group">
                                    <label for="for-atk-input">フォウくん(atk)</label>
                                    <input id="for-atk-input" type="number" class="form-control" value="1000">
                                    <small class="form-text text-muted">
                                        フォウくんで追加されるATKを入力してください
                                    </small>
                                </div>
                            </div>

                            <div class="col-lg-2">
                                <div class="form-group">
                                    <label for="hogu-lv-input">宝具Lv</label>
                                    <select class="form-control" id="hogu-lv-input">
                                        <option value="1">lv1</option>
                                        <option value="2">lv2</option>
                                        <option value="3">lv3</option>
                                        <option value="4">lv4</option>
                                        <option value="5">lv5</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        宝具レベルを選択してください
                                    </small>
                                </div>
                            </div>
                            <div class="col-lg-2">
                                <div class="form-group">
                                    <label for="hogu-oc-input">宝具OC</label>
                                    <select class="form-control" id="hogu-oc-input">
                                        <option value="1">oc1</option>
                                        <option value="2">oc2</option>
                                        <option value="3">oc3</option>
                                        <option value="4">oc4</option>
                                        <option value="5">oc5</option>
                                    </select>
                                    <small class="form-text text-muted">
                                        宝具のOCを選択してください
                                    </small>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label for="target-skill1-lv-input">スキル1Lv</label>
                                    <select class="form-control" id="target-skill1-lv-input">
                                        <option value="">使用しない</option>
                                        <option value="1">lv1</option>
                                        <option value="2">lv2</option>
                                        <option value="3">lv3</option>
                                        <option value="4">lv4</option>
                                        <option value="5">lv5</option>
                                        <option value="6">lv6</option>
                                        <option value="7">lv7</option>
                                        <option value="8">lv8</option>
                                        <option value="9">lv9</option>
                                        <option value="10">lv10</option>
                                    </select>
                                    <small class="form-text text-muted" id="target-skill1-lv-name"></small>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label for="target-skill2-lv-input">スキル2Lv</label>
                                    <select class="form-control" id="target-skill2-lv-input">
                                        <option value="">使用しない</option>
                                        <option value="1">lv1</option>
                                        <option value="2">lv2</option>
                                        <option value="3">lv3</option>
                                        <option value="4">lv4</option>
                                        <option value="5">lv5</option>
                                        <option value="6">lv6</option>
                                        <option value="7">lv7</option>
                                        <option value="8">lv8</option>
                                        <option value="9">lv9</option>
                                        <option value="10">lv10</option>
                                    </select>
                                    <small class="form-text text-muted" id="target-skill2-lv-name"></small>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label for="target-skill3-lv-input">スキル3Lv</label>
                                    <select class="form-control" id="target-skill3-lv-input">
                                        <option value="">使用しない</option>
                                        <option value="1">lv1</option>
                                        <option value="2">lv2</option>
                                        <option value="3">lv3</option>
                                        <option value="4">lv4</option>
                                        <option value="5">lv5</option>
                                        <option value="6">lv6</option>
                                        <option value="7">lv7</option>
                                        <option value="8">lv8</option>
                                        <option value="9">lv9</option>
                                        <option value="10">lv10</option>
                                    </select>
                                    <small class="form-text text-muted" id="target-skill3-lv-name"></small>
                                </div>
                            </div>

                            <div class="col-lg-12">
                                <small class="form-text text-muted">
                                    ※「名称」にて表示された候補サーヴァントを選択することでデータが自動で補間されます
                                </small>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="col-lg-12" style="margin-bottom: 10px;">
                <button type="button" class="btn btn-primary btn-sm toggle-btn" data-target="#target-detail">詳細</button>
                <small class="form-text text-muted">
                    対象サーヴァントのその他データを表示します。<br />一部データは編集不可です。
                </small>
            </div>

            <div class="col-lg-12" id="target-detail" style="display: none">
                <div class="row" style="padding: 15px;">
                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="na-input">N/A</label>
                            <input readonly id="na-input" type="number" class="form-control" value="">
                            <small class="form-text text-muted">NP効率</small>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="hit-input">ヒット数</label>
                            <input readonly type="number" class="form-control" id="hit-input" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="card-input">Card</label>
                            <select disabled class="form-control" id="card-input">
                                <option value=""></option>
                                <option value="a">Arts</option>
                                <option value="b">Buster</option>
                                <option value="q">Quick</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="hogu-type-input">宝具種別</label>
                            <select disabled class="form-control" id="hogu-type-input">
                                <option value=""></option>
                                <option value="support">補助宝具</option>
                                <option value="all">全体宝具</option>
                                <option value="single">単体宝具</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-np-buf-input">NP獲得量バフ</label>
                            <input readonly id="target-np-buf-input" type="text" class="form-control" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-np-get-input">ターン後NP獲得</label>
                            <input readonly id="target-np-get-input" type="text" class="form-control" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-tenchizin-input">天地人</label>
                            <select disabled class="form-control" id="target-tenchizin-input">
                                <option value="ten">天</option>
                                <option value="chi">地</option>
                                <option value="hito">人</option>
                                <option value="hoshi">星</option>
                                <option value="juu">獣</option>
                            </select>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="tokkou-enable-input">特攻宝具</label>
                            <select class="form-control" id="tokkou-enable-input">
                                <option value="y">あり</option>
                                <option value="n">なし</option>
                            </select>
                            <small class="form-text text-muted">
                                宝具ダメージに特攻を反映するか選択します
                            </small>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-compatibility-input">有利不利</label>
                            <select class="form-control" id="target-compatibility-input">
                                <option value="1.0">等倍</option>
                                <option value="2.0">2倍</option>
                                <option value="1.5">1.5倍</option>
                                <option value="0.5">不利</option>
                            </select>
                            <small class="form-text text-muted">
                                敵との相性有利・不利を選択します
                            </small>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-card-buf-input">攻バフ・防デバフ</label>
                            <input readonly id="target-atk-buf-input" type="text" class="form-control" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-card-buf-input">Cardバフ</label>
                            <input readonly id="target-card-buf-input" type="text" class="form-control" value="">
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="target-hogu-buf-input">宝具バフ</label>
                            <input readonly id="target-hogu-buf-input" type="text" class="form-control" value="">
                            <small class="form-text text-muted">その他、特攻バフなど</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <br />

        <div class="row" style="border: 1px solid #f0f0f0;border-radius: 0.25rem;position: relative;">
            <div style="position: absolute;top: -10px;left: 10px;">
                <span class="badge badge-primary" style="cursor: pointer">サポート</span>
            </div>

            <div class="col-lg-12" style="padding-top: 10px;">
                <div class="form-group">
                    <label for="name-input">名称</label>
                    <input autocomplete="off" type="text" class="form-control" id="support-servant-input" value="">
                    <small class="form-text text-muted">
                        サポートサーヴァント名を入力してください
                        <br />
                        入力に応じて候補がサジェスト表示されます。
                    </small>
                </div>
            </div>

            <div class="col-lg-12">
                <div style="padding: 10px; " id="support-box">
                </div>

                <small class="form-text text-muted">
                    ※サポートサーヴァントの状態(スキルLv,使用可否)を編集する場合、
                    対象のサーヴァント名のラベルを押下します
                    <br /><br />
                </small>
            </div>
        </div>

        <br />

        <div class="row" style="border: 1px solid #f0f0f0;border-radius: 0.25rem;position: relative;">
            <div style="position: absolute;top: -10px;left: 10px;">
                <span class="badge badge-primary" style="cursor: pointer">その他</span>
            </div>

            <div class="col-lg-12" style="height: 15px;"></div>

            <div class="col-lg-2">
                <div class="form-group">
                    <label for="target-reisou-level">魔術礼装</label>
                    <select class="form-control" id="target-reisou-level">
                        <option value="1">lv1</option>
                        <option value="2">lv2</option>
                        <option value="3">lv2</option>
                        <option value="4">lv4</option>
                        <option value="5">lv5</option>
                        <option value="6">lv6</option>
                        <option value="7">lv7</option>
                        <option value="8">lv8</option>
                        <option value="9">lv9</option>
                        <option value="10">lv10</option>
                    </select>
                    <small class="form-text text-muted">
                        使用する魔術礼装のLvを選択します
                    </small>
                </div>
            </div>

            <div class="col-lg-10">
                <div class="form-group">
                    <label for="target-reisou-input">&nbsp;</label>
                    <select class="form-control" id="target-reisou-input">
                        <option atk="" a="" b="" q="" hogu="" value="0" help="無し">マスター礼装無し</option>
                        <option atk="30,32,34,36,38,40,42,44,46,50" a="" b="" q="" hogu="" value="1" help="攻30-50アップ">
                            魔術礼装・カルデア</option>
                        <option atk="20,21,22,23,24,25,26,27,28,30" a="" b="" q="" hogu="" value="2" help="攻20-30アップ">
                            カルデア戦闘服</option>
                        <option atk="" a="" b="40,42,44,46,48,50,52,54,56,60" q="" hogu="" value="3" help="B40-60アップ">
                            アニバーサリー・ブロンド(単体B)</option>
                        <option atk="" a="" b="" q="30,32,34,36,38,40,42,44,46,50" hogu="" value="4" help="Q30-50アップ">
                            ロイヤルブランド(単体Q)</option>
                        <option atk="" a="" b="" q="20,21,22,23,24,25,26,27,28,30" hogu="" value="5" help="Q20-30アップ">
                            ブリリアントサマー(全体Q)</option>
                        <option atk="" a="30,32,34,36,38,40,42,44,46,50" b="" q="" hogu="" value="6" help="A30-50アップ">
                            月の海の記憶(単体A)</option>
                        <option atk="" a="20,21,22,23,24,25,26,27,28,30" b="" q="" hogu="" value="7" help="A20-30アップ">
                            月の裏側の記憶(全体A)</option>
                        <option atk="" a="" b="" q="" hogu="30,32,34,36,38,40,42,44,46,50" value="8" help="宝具30-50アップ">
                            2004年の断片(単体宝具)</option>
                        <option atk="" a="20,22,24,26,28,30,32,34,36,40" b="" q="" hogu="10,11,12,13,14,15,16,17,18,20"
                            value="9" help="攻20-40アップ,宝具10-20アップ">極地用カルデア制服(単体ATK+宝具威力)</option>
                        <option atk="20,21,22,23,24,25,26,27,28,30" a="" b="" q="" hogu="10,11,12,13,14,15,16,17,18,20"
                            value="10" help="A20-30アップ,宝具10-20アップ">トロピカルサマー(単体A+宝具威力)</option>
                        <option atk="" a="" b="" q="" hogu="25,26,27,28,29,30,31,32,33,35" value="11" help="宝具25-35アップ">
                            晴れの新年(全体宝具威力)</option>
                    </select>
                    <small class="form-text text-muted">使用する魔術礼装を選択します</small>
                    <div id="reisou-help">
                    </div>
                </div>
            </div>

            <div class="col-lg-12" style="margin-bottom: 10px;">
                <button type="button" class="btn btn-primary btn-sm toggle-btn"
                    data-target="#target-other-buf">詳細</button>
                <small class="form-text text-muted">
                    手動でその他のバフを編集します
                </small>

            </div>

            <div class="col-lg-12" id="target-other-buf" style="display: none">
                <div class="row" style="padding: 15px;">
                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="other-atk-input">ATK(追加)</label>
                            <input id="other-atk-input" type="number" class="form-control" value="0">
                            <small class="form-text text-muted">
                                追加するATKを入力してください。(礼装など)
                            </small>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="other-np-buf-input">NP獲得量バフ</label>
                            <input id="other-np-buf-input" type="number" class="form-control" value="0">
                            <small class="form-text text-muted">
                                NP獲得量アップの値を入力してください
                            </small>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="other-np-get-input">ターン後NP獲得</label>
                            <input id="other-np-get-input" type="number" class="form-control" value="0">
                            <small class="form-text text-muted">
                                ターン終了時に取得できるNPの値を入力してください
                            </small>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="other-card-buf-input">攻バフ・防デバフ</label>
                            <input id="other-atk-buf-input" type="number" class="form-control" value="0">
                            <small class="form-text text-muted">
                                追加する攻撃バフと防御デバフの総計を入力してください
                            </small>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="other-card-buf-input">Cardバフ</label>
                            <input id="other-card-buf-input" type="number" class="form-control" value="0">
                            <small class="form-text text-muted">
                                追加するカードバフの総計を入力してください
                            </small>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="form-group">
                            <label for="other-hogu-buf-input">宝具バフ</label>
                            <input id="other-hogu-buf-input" type="text" class="form-control" value="0">
                            <small class="form-text text-muted">
                                追加する宝具バフの総計を入力してください
                            </small>
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <small class="form-text text-muted">
                            ※その他、特攻バフなどは宝具バフと合算になります
                        </small>
                    </div>
                </div>
            </div>
        </div>

        </br>

        <div class="row" style="border: 1px solid #f0f0f0;border-radius: 0.25rem;position: relative;">
            <div style="position: absolute;top: -10px;left: 10px;">
                <span class="badge badge-primary" style="cursor: pointer">計算結果</span>
            </div>

            <div class="col-lg-12" style="padding-top: 20px">
                <div style="padding: 5px;">
                    <span class="badge badge-dark">獲得NP</span>
                </div>
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th scope="col">OverKill</th>
                            <th scope="col">剣/弓/槍(1.0)</th>
                            <th scope="col">術(1.2)</th>
                            <th scope="col">騎(1.1)</th>
                            <th scope="col">殺(0.9)</th>
                            <th scope="col">狂(0.8)</th>
                        </tr>
                    </thead>
                    <tbody id="result-np-data">
                    </tbody>
                </table>
            </div>

            <div class="col-lg-12" style="padding-top: 20px">
                <div style="padding: 5px;">
                    <span class="badge badge-dark">宝具ダメージ</span>
                </div>
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">最大</th>
                            <th scope="col">中間</th>
                            <th scope="col">最低</th>
                        </tr>
                    </thead>
                    <tbody id="result-damage-data">
                    </tbody>
                </table>
            </div>

            <div class="col-lg-12" id="result-buf-data" style="padding: 10px">
            </div>
        </div>

        <br /><br />

        <div class="modal fade" id="support-detail-modal" tabindex="-1" role="dialog"
            aria-labelledby="support-modal-title" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="support-modal-title"></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">

                        <div class="row">
                            <div class="col-lg-4">
                                <label for="support-skill1-lv-input">スキル1Lv</label>
                                <select class="form-control" id="support-skill1-lv-input" change-target="skill1">
                                    <option value="">使用しない</option>
                                    <option value="v1">lv1</option>
                                    <option value="v2">lv2</option>
                                    <option value="v3">lv3</option>
                                    <option value="v4">lv4</option>
                                    <option value="v5">lv5</option>
                                    <option value="v6">lv6</option>
                                    <option value="v7">lv7</option>
                                    <option value="v8">lv8</option>
                                    <option value="v9">lv9</option>
                                    <option value="v10">lv10</option>
                                </select>
                                <small class="form-text text-muted" id="support-skill1-lv-name"></small>
                            </div>
                            <div class="col-lg-4">
                                <label for="support-skill2-lv-input">スキル2Lv</label>
                                <select class="form-control" id="support-skill2-lv-input" change-target="skill2">
                                    <option value="">使用しない</option>
                                    <option value="v1">lv1</option>
                                    <option value="v2">lv2</option>
                                    <option value="v3">lv3</option>
                                    <option value="v4">lv4</option>
                                    <option value="v5">lv5</option>
                                    <option value="v6">lv6</option>
                                    <option value="v7">lv7</option>
                                    <option value="v8">lv8</option>
                                    <option value="v9">lv9</option>
                                    <option value="v10">lv10</option>
                                </select>
                                <small class="form-text text-muted" id="support-skill2-lv-name"></small>
                            </div>
                            <div class="col-lg-4">
                                <label for="support-skill3-lv-input">スキル3Lv</label>
                                <select class="form-control" id="support-skill3-lv-input" change-target="skill3">
                                    <option value="">使用しない</option>
                                    <option value="v1">lv1</option>
                                    <option value="v2">lv2</option>
                                    <option value="v3">lv3</option>
                                    <option value="v4">lv4</option>
                                    <option value="v5">lv5</option>
                                    <option value="v6">lv6</option>
                                    <option value="v7">lv7</option>
                                    <option value="v8">lv8</option>
                                    <option value="v9">lv9</option>
                                    <option value="v10">lv10</option>
                                </select>
                                <small class="form-text text-muted" id="support-skill3-lv-name"></small>
                            </div>

                            <div class="col-lg-12" id="support-buf-data">
                            </div>

                            <div class="col-lg-12" style="margin-top: 10px;">
                                <button id="support-delete-btn" type="button" class="btn btn-danger btn-sm">削除</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script type="text/x-handlebars" id="template-np-result">
        {{#each this}}
        <tr>
            <td>{{label}}</td>
            <td>{{d1}} ({{a1}})</td>
            <td>{{d2}} ({{a2}})</td>
            <td>{{d3}} ({{a3}})</td>
            <td>{{d4}} ({{a4}})</td>
            <td>{{d5}} ({{a5}})</td>
        </tr>
        {{/each}}
    </script>

    <script type="text/x-handlebars" id="template-damage-result">
        {{#each this}}
        <tr>
            <td>{{label}}</td>
            <td>{{d1}}</td>
            <td>{{d2}}</td>
            <td>{{d3}}</td>
        </tr>
        {{/each}}
    </script>

    <div>
        <script src="../resources/jquery/jquery-3.4.1.min.js"></script>
        <script src="../resources/jquery-ui-1.12.1/jquery-ui.min.js"></script>
        <script src="../resources/bootstrap/js/bootstrap.js"></script>
        <script src="../resources/handlebars/handlebars-v4.2.0.js"></script>
        <script src="../resources/fgoutil/fgocalc.js"></script>
        <script src="../servant.js"></script>

        <script type="text/javascript">
            function reisouHelpHtml() {
                var reisou = $('#target-reisou-input option:selected');
                var html = "";

                var atkVal = reisou.attr("atk");
                var hoguVal = reisou.attr("hogu");
                var aVal = reisou.attr("a");
                var bVal = reisou.attr("b");
                var qVal = reisou.attr("q");

                if (atkVal !== "") {
                    var ary = atkVal.split(",")
                    html += "<span style=\"margin: 5px;\" class=\"badge badge-primary\">攻アップ:" + ary[0] + "-" + ary[ary.length - 1] + "</span>";
                }
                if (hoguVal !== "") {
                    var ary = hoguVal.split(",")
                    html += "<span style=\"margin: 5px;\" class=\"badge badge-primary\">宝具アップ:" + ary[0] + "-" + ary[ary.length - 1] + "</span>";
                }
                if (aVal !== "") {
                    var ary = aVal.split(",")
                    html += "<span style=\"margin: 5px;\" class=\"badge badge-primary\">Aアップ:" + ary[0] + "-" + ary[ary.length - 1] + "</span>";
                }
                if (bVal !== "") {
                    var ary = bVal.split(",")
                    html += "<span style=\"margin: 5px;\" class=\"badge badge-primary\">Bアップ:" + ary[0] + "-" + ary[ary.length - 1] + "</span>";
                }
                if (qVal !== "") {
                    var ary = qVal.split(",")
                    html += "<span style=\"margin: 5px;\" class=\"badge badge-primary\">Qアップ:" + ary[0] + "-" + ary[ary.length - 1] + "</span>";
                }
                return html;
            };

            function reisouBuf(card, lv, reisou, buf) {
                var atkVal = reisou.attr("atk");
                var hoguVal = reisou.attr("hogu");
                var cardVal = reisou.attr(card);

                if (atkVal !== "") {
                    buf.atkbuf += parseInt(atkVal.split(",")[lv - 1]);
                }
                if (hoguVal !== "") {
                    buf.hogubuf += parseInt(hoguVal.split(",")[lv - 1]);
                }
                if (cardVal !== "") {
                    buf.cardbuf += parseInt(cardVal.split(",")[lv - 1]);
                }
            };

            function supportSkillBuff(card, lv, effect, buf) {
                var cardbuflabel = {
                    "a": "Artsカード性能アップ",
                    "q": "Quickカード性能アップ",
                    "b": "Busterカード性能アップ"
                };

                if (effect.target !== "other-single"
                    && effect.target !== "other-all"
                    && effect.target !== "self-other") {

                    return;
                }

                if (effect.type === "NP獲得量アップ") {
                    buf.npbuf += parseFloat(effect[lv]);
                }

                if (effect.type === "NP獲得状態付与") {
                    buf.npget += parseFloat(effect[lv]);
                }

                if (effect.type === cardbuflabel[card]) {
                    buf.cardbuf += parseFloat(effect[lv]);
                }
            };

            function classSkillBuff(card, effect, buf) {
                var cardbuflabel = {
                    "a": "Artsカード性能アップ",
                    "q": "Quickカード性能アップ",
                    "b": "Busterカード性能アップ"
                };

                if (effect.type === "NP獲得量アップ") {
                    buf.npbuf += parseFloat(effect.magnification);
                }

                if (effect.type === "NP獲得状態付与") {
                    buf.npget += parseFloat(effect.magnification);
                }

                if (effect.type === cardbuflabel[card]) {
                    buf.cardbuf += parseFloat(effect.magnification);
                }
            };

            function orgSkillBuff(card, lv, effect, buf) {
                var cardbuflabel = {
                    "a": "Artsカード性能アップ",
                    "q": "Quickカード性能アップ",
                    "b": "Busterカード性能アップ"
                };

                if (effect.target !== "self" && effect.target !== "self-other") {
                    return;
                }

                if (effect.type === "NP獲得量アップ") {
                    buf.npbuf += parseFloat(effect["v" + lv]);
                }

                if (effect.type === "NP獲得状態付与") {
                    buf.npget += parseFloat(effect["v" + lv]);
                }

                if (effect.type === cardbuflabel[card]) {
                    buf.cardbuf += parseFloat(effect["v" + lv]);
                }
            };

            function orgHoguBuff(card, lv, oc, effect, buf) {
                var cardbuflabel = {
                    "a": "Artsカード性能アップ",
                    "q": "Quickカード性能アップ",
                    "b": "Busterカード性能アップ"
                };

                var lvoc = effect.lvoc === "lv" ? "v" + lv : "v" + oc;

                if (effect.target !== "self" && effect.target !== "self-other") {
                    return;
                }

                if (effect.type === "NP獲得量アップ" && effect.beforeafter === "before") {
                    buf.npbuf += parseFloat(effect[lvoc]);
                }

                if (effect.type === "NP獲得状態付与") {
                    buf.npget += parseFloat(effect[lvoc]);
                }

                if (effect.type === "NP獲得" && effect.beforeafter === "after") {
                    buf.npget += parseFloat(effect[lvoc]);
                }

                if (effect.type === cardbuflabel[card] && effect.beforeafter === "before") {
                    buf.cardbuf += parseFloat(effect[lvoc]);
                }
            };

            function getTenchizinCompatibility(enemy, atacker) {
                if(atacker === "ten" && enemy === "hito") {
                    return 1.1;
                }
                if(atacker === "ten" && enemy === "chi") {
                    return 0.9;
                }

                if(atacker === "hito" && enemy === "chi") {
                    return 1.1;
                }
                if(atacker === "hito" && enemy === "ten") {
                    return 0.9;
                }

                if(atacker === "chi" && enemy === "ten") {
                    return 1.1;
                }
                if(atacker === "chi" && enemy === "hito") {
                    return 0.9;
                }

                if(atacker === "hoshi" && enemy === "juu") {
                    return 1.1;
                }
                if(atacker === "juu" && enemy === "hoshi") {
                    return 1.1;
                }

                return 1.0;
            };

            function getServantNo(val) {
                return val.substring(0, val.indexOf("-"));
            };

            function servantLabel(d) {
                return d.servant.no + "-星" + d.servant.rare + "-" + fgo.classToLabel(d.servant.clazz) + "-" + d.servant.name;
            };

            function getServantData(no) {
                var data = fgo.data().find(function (d) {
                    return d.servant.no === no;
                });
                return data ? data : null;
            };

            var calcNp = (function () {
                function bufTo(v) {
                    return v === 0 ? v : v / 100;
                };

                return function (card, na, hoguHit, overkill, hosei, buf) {
                    var val = fgo.calcNp(na, card, bufTo(buf.cardbuf), bufTo(buf.npbuf), hoguHit, overkill, hosei);
                    return Math.round(val * 10) / 10;
                };
            })();

            function parseQuery(str) {
                var data = {};
                var entries = str.split("&");

                for (var i = 0; i < entries.length; i++) {
                    var pair = entries[i];
                    var idx = pair.indexOf("=");

                    if (idx !== -1) {
                        data[pair.substring(0, idx)] = pair.substring(idx + 1);
                    }
                }
                return data;
            };

            function notnull(v, def) {
                return v === undefined || v === null || v === "" ? def : v;
            };

            function supportvalue(v, support, def) {
                for (var i = 0; i < support.length; i++) {
                    if (support[i] === v) {
                        return v;
                    }
                }
                return def;
            };

            var idgen = (function () {
                var counter = 1;
                return function () {
                    return "idx-" + (counter++) + "-dom";
                };
            })();

            function setHash(data) {
                var a = [];
                a.push(data.target.no);
                a.push(data.target.skill1);
                a.push(data.target.skill2);
                a.push(data.target.skill3);
                a.push(data.target.tokkou);
                a.push(data.target.compatibility);
                a.push(data.target.hlv);
                a.push(data.target.hoc);
                a.push(data.target.lv);
                a.push(data.target.fou);

                var r = [];
                r.push(data.reisou.id)
                r.push(data.reisou.lv);

                var e = [];
                e.push(data.custom.addatk);
                e.push(data.custom.npbuf);
                e.push(data.custom.npget);
                e.push(data.custom.atkbuf);
                e.push(data.custom.cardbuf);
                e.push(data.custom.hogubuf);

                var s = [];
                data.suppurts.forEach(function (support) {
                    var v = [];
                    v.push(support.no);
                    v.push(support.skill1);
                    v.push(support.skill2);
                    v.push(support.skill3);
                    v.push(support.skill4);
                    s.push(v.join(","));
                });
                location.hash = "a=" + a.join(",") + "&s=" + s.join(":") + "&r=" + r.join(",") + "&e=" + e.join(",");
            };

            function getHash() {
                var data = {
                    target: {
                        no: "",
                        skill1: "",
                        skill2: "",
                        skill3: "",
                        tokkou: "n",
                        compatibility: "1.0",
                        hlv: 1,
                        hoc: 1,
                        lv: "",
                        fou: 1000,
                        atk: ""
                    },
                    suppurts: [],
                    reisou: {
                        id: 0,
                        lv: 1
                    },
                    custom: {
                        addatk: 0,
                        npbuf: 0,
                        npget: 0,
                        atkbuf: 0,
                        cardbuf: 0,
                        hogubuf: 0
                    }
                };

                var hash = location.hash;
                if (hash === "") {
                    return data;
                }
                var entries = parseQuery(hash.substring(1));

                if (entries["a"] !== undefined && entries["a"] !== null && entries["a"] !== "") {
                    var values = entries["a"].split(",");
                    var servantData = getServantData(notnull(values[0], ""));

                    if (servantData !== null) {
                        var levels = servantData.status.map(function (s) {
                            return s.level;
                        });

                        data.target.no = notnull(values[0], "");
                        data.target.skill1 = supportvalue(values[1], ["", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"], "");
                        data.target.skill2 = supportvalue(values[2], ["", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"], "");
                        data.target.skill3 = supportvalue(values[3], ["", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"], "");
                        data.target.tokkou = supportvalue(values[4], ["y", "n"], "n");
                        data.target.compatibility = supportvalue(values[5], ["1.0", "1.5", "2.0", "0.5"], "1.0");
                        data.target.hlv = supportvalue(values[6], ["1", "2", "3", "4", "5"], servantData.servant.rare >= 4 ? "1" : "5");
                        data.target.hoc = supportvalue(values[7], ["1", "2", "3", "4", "5"], servantData.servant.rare >= 4 ? "1" : "5");
                        data.target.lv = supportvalue(values[8], levels, levels[0]);
                        data.target.fou = isNaN(parseInt(values[9])) ? 1000 : parseInt(values[9]);

                        data.target.atk = servantData.status.find(function (s) {
                            return s.level === data.target.lv;
                        }).atk;
                    }
                }

                if (entries["s"] !== undefined && entries["s"] !== null && entries["s"] !== "") {
                    var supports = entries["s"].split(":");
                    for (var i = 0; i < supports.length; i++) {
                        var values = supports[i].split(",");

                        var servantData = getServantData(notnull(values[0], ""));
                        if (servantData === null) {
                            continue;
                        }

                        data.suppurts.push({
                            no: notnull(values[0], ""),
                            id: idgen(),
                            skill1: supportvalue(values[1], ["", "v1", "v2", "v3", "v4", "v5", "v6", "v7", "v8", "v9", "v10"], ""),
                            skill2: supportvalue(values[2], ["", "v1", "v2", "v3", "v4", "v5", "v6", "v7", "v8", "v9", "v10"], ""),
                            skill3: supportvalue(values[3], ["", "v1", "v2", "v3", "v4", "v5", "v6", "v7", "v8", "v9", "v10"], "")
                        });
                    }
                }

                if (entries["r"] !== undefined && entries["r"] !== null && entries["r"] !== "") {
                    var values = entries["r"].split(",");
                    data.reisou.id = parseInt(supportvalue(values[0], ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10"], "0"));
                    data.reisou.lv = parseInt(supportvalue(values[1], ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"], "1"));
                }

                if (entries["e"] !== undefined && entries["e"] !== null && entries["e"] !== "") {
                    var values = entries["e"].split(",");

                    data.custom.addatk = isNaN(parseInt(values[0])) ? 0 : parseFloat(values[0]);
                    data.custom.npbuf = isNaN(parseInt(values[1])) ? 0 : parseFloat(values[1]);
                    data.custom.npget = isNaN(parseInt(values[2])) ? 0 : parseFloat(values[2]);
                    data.custom.atkbuf = isNaN(parseInt(values[3])) ? 0 : parseFloat(values[3]);
                    data.custom.cardbuf = isNaN(parseInt(values[4])) ? 0 : parseFloat(values[4]);
                    data.custom.hogubuf = isNaN(parseInt(values[5])) ? 0 : parseFloat(values[5]);
                }

                return data;
            };

            function rerender(data) {
                var servantData = getServantData(data.target.no);
                $("#target-servant-input").val(servantData !== null ? servantLabel(servantData) : "");

                var status = servantData !== null ? servantData.status : [];
                $("#level-input").html(status.map(function (sdata) {
                    return "<option atk=\"" + (sdata.atk) + "\" value=\"" + (sdata.level) + "\">" + (sdata.level) + "</option>";
                }).join(""));
                $("#level-input").val(data.target.lv);

                $("#atk-input").val(data.target.atk);
                $("#for-atk-input").val(data.target.fou);
                $("#hogu-lv-input").val(data.target.hlv);
                $("#hogu-oc-input").val(data.target.hoc);

                $("#target-skill1-lv-input").val(data.target.skill1);
                $("#target-skill1-lv-name").text(servantData != null ? servantData.skill1.name : "");
                $("#target-skill2-lv-input").val(data.target.skill2);
                $("#target-skill2-lv-name").text(servantData != null ? servantData.skill2.name : "");
                $("#target-skill3-lv-input").val(data.target.skill3);
                $("#target-skill3-lv-name").text(servantData != null ? servantData.skill3.name : "");


                $("#tokkou-enable-input").val(data.target.tokkou);
                $("#target-compatibility-input").val(data.target.compatibility);
                $("#target-tenchizin-input").val(servantData != null ? servantData.servant.tenchizin : "");

                $("#na-input").val(servantData != null ? servantData.hidden.na : "");
                $("#hit-input").val(servantData != null ? servantData.hogu.hit : "");
                $("#card-input").val(servantData != null ? servantData.hogu.card : "");
                $("#hogu-type-input").val(servantData != null ? servantData.hogu.type : "");

                var atackerbuf = { npbuf: 0, cardbuf: 0, npget: 0, atkbuf: 0, hogubuf: 0 };

                var classskill = servantData != null ? servantData.classskill : [];
                classskill.forEach(function (s) {
                    s.effect.forEach(function (e) {
                        classSkillBuff(servantData.hogu.card, e, atackerbuf);
                    });
                });

                if (data.target.skill1 !== "" && servantData != null) {
                    servantData.skill1.effects.forEach(function (e) {
                        orgSkillBuff(servantData.hogu.card, data.target.skill1, e, atackerbuf);
                    });
                }
                if (data.target.skill2 !== "" && servantData != null) {
                    servantData.skill2.effects.forEach(function (e) {
                        orgSkillBuff(servantData.hogu.card, data.target.skill2, e, atackerbuf);
                    });
                }

                if (data.target.skill3 !== "" && servantData != null) {
                    servantData.skill3.effects.forEach(function (e) {
                        orgSkillBuff(servantData.hogu.card, data.target.skill3, e, atackerbuf);
                    });
                }

                if (servantData !== null) {
                    servantData.hogu.effect.forEach(function (e) {
                        orgHoguBuff(servantData.hogu.card, data.target.hlv, data.target.hoc, e, atackerbuf);
                    });
                }

                $("#target-card-buf-input").val(atackerbuf.cardbuf);
                $("#target-np-buf-input").val(atackerbuf.npbuf);
                $("#target-np-get-input").val(atackerbuf.npget);
                $("#target-atk-buf-input").val(atackerbuf.atkbuf);
                $("#target-hogu-buf-input").val(atackerbuf.hogubuf);

                $("#target-reisou-level").val(data.reisou.lv);
                $("#target-reisou-input").val(data.reisou.id);

                $("#reisou-help").html(reisouHelpHtml());

                $("#other-atk-input").val(data.custom.addatk);
                $("#other-np-buf-input").val(data.custom.npbuf);
                $("#other-np-get-input").val(data.custom.npget);
                $("#other-atk-buf-input").val(data.custom.atkbuf);
                $("#other-card-buf-input").val(data.custom.cardbuf);
                $("#other-hogu-buf-input").val(data.custom.hogubuf);

                $("#support-box").html("");
                for (var i = 0; i < data.suppurts.length; i++) {
                    var support = data.suppurts[i];
                    var supportServantData = getServantData(support.no);

                    $("#support-box").append($("<span>").attr("class", "badge badge-dark")
                        .attr("style", "cursor: pointer;padding: 10px;margin: 3px;")
                        .attr("id", support.id)
                        .attr("data-no", support.no)
                        .attr("skill1", support.skill1)
                        .attr("skill2", support.skill2)
                        .attr("skill3", support.skill3)
                        .text(servantLabel(supportServantData)));

                    if (support.skill1 !== "") {
                        supportServantData.skill1.effects.forEach(function (e) {
                            supportSkillBuff(servantData.hogu.card, support.skill1, e, atackerbuf);
                        });
                    }
                    if (support.skill2 !== "") {
                        supportServantData.skill2.effects.forEach(function (e) {
                            supportSkillBuff(servantData.hogu.card, support.skill2, e, atackerbuf);
                        });
                    }
                    if (support.skill3 !== "") {
                        supportServantData.skill3.effects.forEach(function (e) {
                            supportSkillBuff(servantData.hogu.card, support.skill3, e, atackerbuf);
                        });
                    }
                }

                atackerbuf.cardbuf += data.custom.cardbuf;
                atackerbuf.npbuf += data.custom.npbuf;
                atackerbuf.npget += data.custom.npget;
                atackerbuf.atkbuf += data.custom.atkbuf;
                atackerbuf.hogubuf += data.custom.hogubuf;

                if(servantData !== null) {
                    reisouBuf(servantData.hogu.card, data.reisou.lv, $("#target-reisou-input option:selected"), atackerbuf);
                }

                var cardHosei = servantData !== null ? fgo.getCardNp(servantData.hogu.card) : 0;
                var hoguHit = servantData !== null ? servantData.hogu.hit : 0;
                var na = servantData !== null ? servantData.hidden.na : 0;

                var lastAtk = data.target.atk + data.target.fou + data.custom.addatk;

                var calcNpResult = [];
                for (var i = 0; i < hoguHit; i++) {
                    var d1 = calcNp(cardHosei, na, hoguHit, i + 1, 1.0, atackerbuf);
                    var d2 = calcNp(cardHosei, na, hoguHit, i + 1, 1.2, atackerbuf);
                    var d3 = calcNp(cardHosei, na, hoguHit, i + 1, 1.1, atackerbuf);
                    var d4 = calcNp(cardHosei, na, hoguHit, i + 1, 0.9, atackerbuf);
                    var d5 = calcNp(cardHosei, na, hoguHit, i + 1, 0.8, atackerbuf);
                    calcNpResult.push({
                        label: "OverKill " + (i + 1),
                        d1: d1 + atackerbuf.npget,
                        d2: d2 + atackerbuf.npget,
                        d3: d3 + atackerbuf.npget,
                        d4: d4 + atackerbuf.npget,
                        d5: d5 + atackerbuf.npget,
                        a1: Math.round(((d1 * 3) + atackerbuf.npget) * 10) / 10,
                        a2: Math.round(((d2 * 3) + atackerbuf.npget) * 10) / 10,
                        a3: Math.round(((d3 * 3) + atackerbuf.npget) * 10) / 10,
                        a4: Math.round(((d4 * 3) + atackerbuf.npget) * 10) / 10,
                        a5: Math.round(((d5 * 3) + atackerbuf.npget) * 10) / 10
                    });
                }

                var calcDamageResult = [];

                if(servantData !== null) {
                }

                var template_np = Handlebars.compile($("#template-np-result").html());
                $("#result-np-data").html(template_np(calcNpResult));

                var template_damage = Handlebars.compile($("#template-damage-result").html());
                $("#result-damage-data").html(template_damage(calcDamageResult));

                var cumulative = [];

                if(servantData !== null) {
                    cumulative.push("基礎倍率:0.23");
                    cumulative.push("カードNP補正:" + cardHosei);
                    cumulative.push("カード補正:" + atackerbuf.cardbuf);
                    cumulative.push("攻防力補正:" + atackerbuf.atkbuf);
                    cumulative.push("宝具威力補正:" + atackerbuf.hogubuf);
                    cumulative.push("NP獲得量補正:" + atackerbuf.npbuf);
                    cumulative.push("ターン後NP獲得:" + atackerbuf.npget);
                }

                $("#result-buf-data").html(cumulative.map(function (c) {
                    return "<span style=\"margin: 5px;\" class=\"badge badge-primary\">" + c + "</span>";
                }).join(""));
            };

            $(function () {
                /* 初期化 start */
                var initialData = (function () {
                    var d = getHash();
                    setHash(d);
                    rerender(d);
                    return d;
                })();
                /* 初期化 end */

                var servantAutoCompleteData = fgo.data().map(function (d) {
                    return servantLabel(d);
                });

                /* その他イベント start */
                (function () {
                    $(document).on("click", ".toggle-btn", function () {
                        var targetId = $(this).attr("data-target");
                        var target = $(targetId);
                        if (target.is(':visible')) {
                            target.hide();
                        } else {
                            target.show();
                        }
                    });

                    $("#clearnBtn").click(function () {
                        location.hash = "";
                        initialData = getHash();
                        setHash(initialData);
                        rerender(initialData);
                    });
                })();
                /* その他イベント end */

                /* アタッカー部分のイベント start */
                (function () {
                    $("#target-servant-input").autocomplete({
                        source: servantAutoCompleteData,
                        select: function (e, d) {
                            var no = getServantNo(d.item.value);
                            var servantData = getServantData(no);

                            var status = servantData.status[0];

                            initialData.target.no = no;
                            initialData.target.skill1 = "10";
                            initialData.target.skill2 = "10";
                            initialData.target.skill3 = "10";
                            initialData.target.tokkou = "n";
                            initialData.target.compatibility = fgo.getCompatibility(1, servantData.servant.clazz) + "";
                            initialData.target.hlv = servantData.servant.rare >= 4 ? "1" : "5";
                            initialData.target.hoc = servantData.servant.rare >= 4 ? "1" : "5";
                            initialData.target.lv = status.level;
                            initialData.target.fou = 1000;
                            initialData.target.atk = status.atk;

                            $("#target-servant-input").blur();
                            rerender(initialData);
                            setHash(initialData);
                        }
                    });

                    $("#level-input").change(function () {
                        var selected = $("#level-input option:selected");
                        var lv = selected.val("");
                        var atk = parseInt(selected.attr("atk"));

                        initialData.target.lv = lv;
                        initialData.target.atk = atk;
                        $("#for-atk-input").val(atk);

                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#for-atk-input").change(function () {
                        var val = parseInt($(this).val());
                        initialData.target.fou = val;
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#hogu-lv-input").change(function () {
                        initialData.target.hlv = $(this).val();
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#hogu-oc-input").change(function () {
                        initialData.target.hoc = $(this).val();
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#target-skill1-lv-input").change(function () {
                        initialData.target.skill1 = $(this).val();
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#target-skill2-lv-input").change(function () {
                        initialData.target.skill2 = $(this).val();
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#target-skill3-lv-input").change(function () {
                        initialData.target.skill3 = $(this).val();
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#tokkou-enable-input").change(function () {
                        initialData.target.tokkou = $(this).val();
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#target-compatibility-input").change(function () {
                        initialData.target.compatibility = $(this).val();
                        rerender(initialData);
                        setHash(initialData);
                    });

                })();
                /* アタッカー部分のイベント end */

                /* 礼装、その他バフ部分のイベント start */
                (function () {

                    $("#target-reisou-level").change(function () {
                        initialData.reisou.lv = parseInt($(this).val());
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#target-reisou-input").change(function () {
                        initialData.reisou.id = $(this).val();
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#other-atk-input").change(function () {
                        initialData.custom.addatk = parseInt($(this).val());
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#other-np-buf-input").change(function () {
                        initialData.custom.npbuf = parseFloat($(this).val());
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#other-np-get-input").change(function () {
                        initialData.custom.npget = parseFloat($(this).val());
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#other-atk-buf-input").change(function () {
                        initialData.custom.atkbuf = parseFloat($(this).val());
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#other-card-buf-input").change(function () {
                        initialData.custom.cardbuf = parseFloat($(this).val());
                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#other-hogu-buf-input").change(function () {
                        initialData.custom.hogubuf = parseFloat($(this).val());
                        rerender(initialData);
                        setHash(initialData);
                    });
                })();
                /* 礼装、その他バフ部分のイベント end */

                /* サポート部分のイベント start */
                (function () {
                    function updateSupportBufDialogData(no) {
                        var html = "";

                        var data = getServantData(no);
                        var skill1 = $("#support-skill1-lv-input").val();
                        var skill2 = $("#support-skill2-lv-input").val();
                        var skill3 = $("#support-skill3-lv-input").val();

                        if (skill1 !== "") {
                            data.skill1.effects.forEach(function (e) {
                                if (e.target !== "other-single"
                                    && e.target !== "other-all"
                                    && e.target !== "self-other") {

                                    return;
                                }

                                html += "<span style=\"margin: 5px;\" class=\"badge badge-primary\">"
                                    + (e.type) + ":" + e[skill1] + "</span>";
                            });
                        }

                        if (skill2 !== "") {
                            data.skill2.effects.forEach(function (e) {
                                if (e.target !== "other-single"
                                    && e.target !== "other-all"
                                    && e.target !== "self-other") {

                                    return;
                                }

                                html += "<span style=\"margin: 5px;\" class=\"badge badge-primary\">" + (e.type) + ":" + e[skill2] + "</span>";
                            });
                        }
                        if (skill3 !== "") {
                            data.skill3.effects.forEach(function (e) {
                                if (e.target !== "other-single"
                                    && e.target !== "other-all"
                                    && e.target !== "self-other") {

                                    return;
                                }

                                html += "<span style=\"margin: 5px;\" class=\"badge badge-primary\">" + (e.type) + ":" + e[skill3] + "</span>";
                            });
                        }

                        $("#support-buf-data").html(html);
                    };

                    $("#support-servant-input").autocomplete({
                        source: servantAutoCompleteData,
                        select: function (e, d) {
                            var no = getServantNo(d.item.value);

                            initialData.suppurts.push({
                                no: no,
                                id: idgen(),
                                skill1: "v10",
                                skill2: "v10",
                                skill3: "v10"
                            });

                            $("#support-servant-input").blur();
                            rerender(initialData);
                            setHash(initialData);
                        }
                    });

                    $("#support-servant-input").focus(function () {
                        $("#support-servant-input").val("");
                    });

                    $(document).on("click", "#support-box span", function () {
                        var no = $(this).attr("data-no");
                        var data = getServantData(no);

                        var domid = $(this).attr("id");
                        var title = data.servant.no + "-星" + data.servant.rare + "-"
                            + fgo.classToLabel(data.servant.clazz) + "-" + data.servant.name;

                        $('#support-detail-modal').attr("target-dom-id", domid);
                        $('#support-detail-modal').attr("data-no", no);

                        $("#support-modal-title").text(title);

                        $("#support-skill1-lv-input").val($(this).attr("skill1"));
                        $("#support-skill2-lv-input").val($(this).attr("skill2"));
                        $("#support-skill3-lv-input").val($(this).attr("skill3"));

                        $("#support-skill1-lv-name").text(data.skill1.name);
                        $("#support-skill2-lv-name").text(data.skill2.name);
                        $("#support-skill3-lv-name").text(data.skill3.name);

                        updateSupportBufDialogData(no);
                        $('#support-detail-modal').modal('show');
                    });

                    $("#support-delete-btn").click(function () {
                        $('#support-detail-modal').modal('hide');
                        var domid = $('#support-detail-modal').attr("target-dom-id");

                        initialData.suppurts = initialData.suppurts.filter(function (d) {
                            return d.id !== domid;
                        });

                        rerender(initialData);
                        setHash(initialData);
                    });

                    $("#support-skill1-lv-input,#support-skill2-lv-input,#support-skill3-lv-input").change(function () {
                        var no = $('#support-detail-modal').attr("data-no");
                        updateSupportBufDialogData(no);

                        var domid = $('#support-detail-modal').attr("target-dom-id");
                        var key = $(this).attr("change-target");
                        var support = initialData.suppurts.find(function (d) {
                            return d.id == domid;
                        });

                        support[key] = $(this).val();

                        rerender(initialData);
                        setHash(initialData);
                    });

                })();
                /* サポート部分のイベント end */
            });
        </script>
    </div>
</body>

</html>